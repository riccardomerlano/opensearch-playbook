# NTT Data customizations

## Execution

### SSH Keys

TODO

### Configuration

TODO

### Playbook

Execute the following command

      /ansible-playbook -i inventories/opensearch/hosts opensearch.yml --extra-vars "admin_password=Test_123 kibanaserver_password=Test_6789" --private-key=~/.ssh/my-ssh-key

## LOGSTASH OSS

We added a specific role to deploy Logstash OSS

### Clean Logstash OSS installation

First stop the service

      service logstash stop

Cleanup current installation with the following commands

     rm -f /tmp/logstash.tar.gz
     rm -rf /usr/share/logstash
     rm -f /etc/systemd/system/logstash.service
     systemctl daemon-reload 

## NTT added features configuration

### Installation Mode

In order to generalize the Ansible to be effective also on host machines which do not have access to outer internet, the *Installation Mode Config* was added to the `inventories/opensearch/group_vars/all/all.yml` file.

There are three possible values for `installation_mode` variable:

- **online**: the host machine has *full access to outer internet*, so the zipped files for installation are dowloaded directly on the host machine;
- **ssh**: the host machine *hasn't access to outer internet*, but *it can be reached through ssh*. In this case the zipped files for installation are downloaded first on Master machine and then copied on host machine through scp. In `ssh` mode the directory in which are downloaded the files on the Master machine should be indicated in `temp_tar_dir`;
- **offline**: the host machine *hasn't any web access* outside the machine itself, the installation is completely made through localhost (REMEBER: in this case launch `ansible-playbook` with `--connection local` switch). In this case must be defined the `offline_tar_dir` variable that represents the directory on the host machine in which the zipped componentes fon installation can be found (**Note**: should be present the zip/tar for opensearch, opensearch-dashboards and logstash).

The management of this installataion mode can be found in `roles/centos7/openseach/tasks/openserach.yml`, `roles/centos7/dashboards/tasks/dashboards.yml` and `roles/centos7/logstash/tasks/logstash.yml`


### Cert_generator.sh

Creation of certificates for node-to-node encryption was automated through the execution of `cert_generator.sh` in `roles/centos7/opensearch/templates`. This shell executable creates a directory on the Master machine (the path can be defined in `localhost_certs_dir`) in which certificates are generated, after that the execution of the Ansible copy those certificates in the correct direcories on the host machine. The generated certificates are:

- **root-ca** and **root-ca-key**: the Root Certificate Authority;
- **admin** and **admin-key**: certificates for opensearch admin;
- ***hostname*** and ***hostname*-key**: certificates for nodes (one for each node in the cluster);
- **dashboard** and **dashboard-key**: certificates for https connection to dashboards. By default these are self-signed, for proprietary certificates see [Proprietary Dashboard Certificates](Proprietary-Dashboard-Certificates) (dashboards certificates will be not generated in this case).

The management of certificates generation and installation can be found in `roles/centos7/openseach/tasks/security.yml` and `roles/centos7/dashboards/tasks/dashboards.yml`, while the configuration on the host machines can be found rispectively in `roles/centos7/openseach/templates/security-conf.yml` and `roles/centos7/dashboards/templates/opensearch_dashboards.yml`.

### Proprietary Dashboard Certificates

Since the dashboards certificates for https communication are self-signed when they are generated by [cert_generator.sh](Cert_generator.sh), they aren't accepeted by some browsers (i.e. Google Chrome) In order to avoid the browser block or warning, a custom certificate, signed by a recognized CA, can be provided to the Ansible and installed through the automated process.

To configure this aspect, there are three possible values for `proprietary_dashboard_cert` variable:

- **no_cert**: certificate and key aren't provided, they will be generated by [cert_generator.sh](Cert_generator.sh) and will be self-signed;
- **local**: certificate and key are provided and are stored on the ansible Master machine;
- **remote**: certificate and key are provided and are stored on the ansible Remote Host machine.

Both in **local** and **remote** mode, the exact directory path in wich certificate are stored must be defined through `proprietary_dashboard_cert_dir` while certificate and key name must be expressed thorugh `proprietary_dashboard_cert_name` and `proprietary_dashboard_key_name`

The management of this feature can be found in `roles/centos7/dashboards/tasks/dashboards.yml` and `roles/centos7/dashboards/templates/opensearch_dashboards.yml`.